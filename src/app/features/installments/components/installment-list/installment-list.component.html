<h2 class="text-xl font-bold">Installation List</h2>
<br>

<div class="relative overflow-x-auto shadow-md sm:rounded-lg">
    <table class="w-full text-sm text-left rtl:text-right text-gray-500 dark:text-gray-400">
        <thead class="text-xs text-gray-700 uppercase bg-gray-50 dark:bg-gray-700 dark:text-gray-400">
            <tr>
                <th scope="col" class="px-6 py-3">
                    Installment Number
                </th>
                <th scope="col" class="px-6 py-3">
                    Amount
                </th>
                <th scope="col" class="px-6 py-3">
                    Due Date
                </th>
                <th scope="col" class="px-6 py-3">
                    Payment Date
                </th>
                <th scope="col" class="px-6 py-3">
                    Status
                </th>
                <th scope="col" class="px-6 py-3">
                    Actions
                </th>
            </tr>
        </thead>
        <tbody>
          @for (installment of installments; track installment.installmentId)
          {
            <tr class="bg-white border-b dark:bg-gray-800 dark:border-gray-700 border-gray-200 hover:bg-gray-50 dark:hover:bg-gray-600">
              <td class="px-6 py-4 font-medium text-gray-900">
                  {{ installment.installmentNumber }}
              </td>
              <td scope="row" class="px-6 py-4 font-medium text-gray-900 whitespace-nowrap dark:text-white">
                  {{ installment.amount | currency:'S/':'symbol':'1.2-2' }}
              </td>
              <td class="px-6 py-4">
                  {{ installment.dueDate | date:'dd MMMM yyyy' }}
              </td>
              <td class="px-6 py-4">
                  <ng-container *ngIf="installment.paymentDate; else notDone">
                    {{ installment.paymentDate | date:'dd/MM/yyyy' }}
                  </ng-container>
                  <ng-template #notDone>
                    <span class="italic text-gray-500">Not done yet</span>
                  </ng-template>
              </td>
              <td class="px-6 py-4">
                <span
                  class="inline-flex items-center rounded-full px-2 py-0.5 text-xs font-medium"
                  [ngClass]="{
                    'bg-green-100 text-green-800': installment.status === 'Paid',
                    'bg-red-100 text-red-800': installment.status === 'Overdue',
                    'bg-yellow-100 text-yellow-800': installment.status === 'Pending'
                  }"
                >
                  {{ installment.status }}
                </span>
              </td>
              <td class="px-6 py-4">
                <ng-container *ngIf="installment.status !== 'Paid'; else paidAction">
                  <a
                    (click)="openConfirm(installment)"
                    class="font-medium text-blue-600 hover:underline cursor-pointer"
                  >
                    Pay
                  </a>
                </ng-container>
                <ng-template #paidAction>
                  <span class="italic text-gray-500">Already paid</span>
                </ng-template>
              </td>
            </tr>
          }
          @empty {
            <tr>
              <td colspan="7" class="text-center">
                <p class="my-2">No installments to display</p>
              </td>
            </tr>
          }
        </tbody>
    </table>
</div>
<br>
<div class="mb-4">
  <a
    [routerLink]="['/loans']"
    class="inline-flex items-center px-4 py-2 bg-gray-200 hover:bg-gray-300 text-gray-800 text-sm font-medium rounded-md shadow-sm transition-colors duration-200"
  >
    <!-- Heroicon: Arrow Left -->
    <svg
      class="w-4 h-4 mr-2"
      fill="none"
      stroke="currentColor"
      stroke-width="2"
      viewBox="0 0 24 24"
      xmlns="http://www.w3.org/2000/svg"
    >
      <path stroke-linecap="round" stroke-linejoin="round" d="M15 19l-7-7 7-7"></path>
    </svg>
    Back to Loans
  </a>
</div>

<!-- Confirm Modal -->
<div *ngIf="showConfirm" class="fixed inset-0 z-40 flex items-center justify-center">
  <!-- Backdrop -->
  <div class="absolute inset-0 bg-black/40" (click)="closeConfirm()"></div>

  <!-- Dialog -->
  <div
    class="relative z-50 w-full max-w-md rounded-lg bg-white p-6 shadow-xl dark:bg-gray-800"
    role="dialog"
    aria-modal="true"
  >
    <h3 class="text-lg font-semibold text-gray-900 dark:text-white mb-2">
      Confirm Payment
    </h3>
    <p class="text-sm text-gray-600 dark:text-gray-300 mb-4">
      Are you sure you want to pay installment
      <span class="font-medium">#{{ selectedInstallment?.installmentNumber }}</span>
      for <span class="font-medium">
        {{ selectedInstallment?.amount | currency:'S/':'symbol':'1.2-2' }}
      </span>?
    </p>

    <div class="flex items-center justify-end gap-3">
      <button
        type="button"
        (click)="closeConfirm()"
        class="px-4 py-2 rounded-md text-sm font-medium bg-gray-200 hover:bg-gray-300 text-gray-800"
        [disabled]="isProcessing"
      >
        Cancel
      </button>

      <button
        type="button"
        (click)="confirmPay()"
        class="px-4 py-2 rounded-md text-sm font-medium bg-blue-600 hover:bg-blue-700 text-white disabled:opacity-60"
        [disabled]="isProcessing"
      >
        Accept
      </button>
    </div>
  </div>
</div>

<!-- Processing Overlay -->
@if (isProcessing) {
  <div class="fixed inset-0 z-50 grid place-items-center bg-black/40">
    <div class="flex flex-col items-center gap-3 rounded-lg bg-white px-6 py-5 shadow-lg dark:bg-gray-800">
      <!-- Spinner -->
      <svg class="h-6 w-6 animate-spin" viewBox="0 0 24 24" aria-hidden="true">
        <circle class="opacity-25" cx="12" cy="12" r="10"
                stroke="currentColor" stroke-width="4" fill="none"></circle>
        <path class="opacity-75" fill="currentColor"
              d="M4 12a8 8 0 018-8v4a4 4 0 00-4 4H4z"></path>
      </svg>
      <p class="text-sm text-gray-700 dark:text-gray-200">Processing paymentâ€¦</p>
    </div>
  </div>
}
